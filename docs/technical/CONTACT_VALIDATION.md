# Valida√ß√£o de Contatos - Pathfinder Management System

## üìã Vis√£o Geral

Este documento detalha o sistema de valida√ß√£o de contatos implementado no PMS, incluindo valida√ß√µes de frontend, backend e regras de neg√≥cio espec√≠ficas.

## üéØ Regras de Neg√≥cio

### 1. **Contatos Prim√°rios**
- ‚úÖ **Apenas um telefone pode ser prim√°rio** por membro
- ‚úÖ **Apenas um email pode ser prim√°rio** por membro
- ‚úÖ **Um telefone prim√°rio + um email prim√°rio** podem coexistir
- ‚úÖ **Valida√ß√£o visual** no frontend com bot√µes desabilitados
- ‚úÖ **Valida√ß√£o no backend** antes de salvar

### 2. **Tipos de Contato Suportados**
```typescript
enum ContactType {
  Email = 3,
  Mobile = 1,      // Telefone celular
  Landline = 2,    // Telefone fixo
  WhatsApp = 4,
  Facebook = 5,
  Instagram = 6,
  YouTube = 7,
  TikTok = 8,
  LinkedIn = 9,
  Twitter = 10,
  Website = 11,
  Other = 99
}
```

### 3. **Valida√ß√µes de Formato**

#### Telefone
- ‚úÖ **Formato internacional**: `+5511999999999`
- ‚úÖ **DDI autom√°tico**: Sele√ß√£o por pa√≠s
- ‚úÖ **Formata√ß√£o visual**: `+55 11 99999-9999`
- ‚úÖ **Valida√ß√£o de comprimento**: 10-15 d√≠gitos
- ‚úÖ **Valida√ß√£o de pa√≠s**: DDI v√°lido

#### Email
- ‚úÖ **Formato b√°sico**: `usuario@dominio.com`
- ‚úÖ **Comprimento m√≠nimo**: 5 caracteres
- ‚úÖ **Valida√ß√£o de @**: Obrigat√≥rio
- ‚úÖ **Valida√ß√£o de dom√≠nio**: Pelo menos 3 caracteres

## üîß Implementa√ß√£o T√©cnica

### Frontend (React/TypeScript)

#### 1. **Componente PhoneInputWithDDI**
```typescript
interface PhoneInputWithDDIProps {
  value: string;                    // N√∫mero internacional completo
  onChange: (value: string) => void;
  onValidationChange?: (isValid: boolean) => void;
  defaultCountry?: CountryCode;
}

// Valida√ß√£o em tempo real
useEffect(() => {
  const fullNumber = selectedCountry === "BR" 
    ? `+55${phoneNumber}` 
    : `+${getCountryCallingCode(selectedCountry)}${phoneNumber}`;
  
  const valid = !phoneNumber || libIsValidPhoneNumber(fullNumber);
  setIsValid(valid);
  onValidationChange?.(valid);
}, [phoneNumber, selectedCountry]);
```

#### 2. **Valida√ß√£o de Contatos Prim√°rios**
```typescript
const canBePrimary = (index: number) => {
  const targetContact = formData[index];
  const contactType = targetContact.type;
  
  // Verifica se j√° existe outro contato do mesmo tipo marcado como prim√°rio
  const hasOtherPrimaryOfSameType = formData.some((contact, i) =>
    i !== index && contact.type === contactType && contact.isPrimary
  );
  
  return !hasOtherPrimaryOfSameType;
};
```

#### 3. **Mapeamento de Tipos Frontend ‚Üî Backend**
```typescript
// Frontend ‚Üí Backend
const mapContactTypeToBackend = (frontendType: string): number => {
  const typeMap: Record<string, number> = {
    "Email": 3,
    "Phone": 1,      // Mobile
    "WhatsApp": 4,
    "Mobile": 1,
    "Landline": 2,
    "Facebook": 5,
    "Instagram": 6,
    "YouTube": 7,
    "TikTok": 8,
    "LinkedIn": 9,
    "Twitter": 10,
    "Website": 11,
    "Other": 99
  };
  return typeMap[frontendType] || 99;
};

// Backend ‚Üí Frontend
const mapContactTypeFromBackend = (backendType: number): string => {
  const typeMap: Record<number, string> = {
    1: "Phone",      // Mobile
    2: "Phone",      // Landline
    3: "Email",
    4: "WhatsApp",
    5: "Facebook",
    6: "Instagram",
    7: "YouTube",
    8: "TikTok",
    9: "LinkedIn",
    10: "Twitter",
    11: "Website",
    99: "Other"
  };
  return typeMap[backendType] || "Other";
};
```

### Backend (C# .NET)

#### 1. **DTOs com Valida√ß√£o**
```csharp
public class UpdateMyContactsRequestDto
{
    [Required(ErrorMessage = "Token √© obrigat√≥rio")]
    public string Token { get; set; } = string.Empty;

    [Required(ErrorMessage = "A lista de contatos n√£o pode ser nula.")]
    public IEnumerable<MemberContactDto> Contacts { get; set; } = new List<MemberContactDto>();
}

public class MemberContactDto
{
    [Required]
    public ContactType Type { get; set; }

    [Required]
    [StringLength(255, MinimumLength = 3, ErrorMessage = "Valor deve ter entre 3 e 255 caracteres")]
    public string Value { get; set; } = string.Empty;

    public bool IsPrimary { get; set; }
    public string? Notes { get; set; }
}
```

#### 2. **Valida√ß√£o na Camada de Servi√ßo**
```csharp
public async Task<BaseResponse<IEnumerable<MemberContactDto>>> UpdateMyContactsAsync(
    UpdateMyContactsRequestDto request, CancellationToken cancellationToken = default)
{
    // 1. Valida√ß√£o de dados de entrada
    if (string.IsNullOrEmpty(request.Token))
    {
        return BaseResponse<IEnumerable<MemberContactDto>>.ErrorResult("Token √© obrigat√≥rio", statusCode: 400);
    }

    if (request.Contacts == null || !request.Contacts.Any())
    {
        return BaseResponse<IEnumerable<MemberContactDto>>.ErrorResult("Lista de contatos n√£o pode ser vazia", statusCode: 400);
    }

    // 2. Valida√ß√£o de token
    var userInfo = _authService.GetUserInfoFromToken(request.Token);
    if (!userInfo.IsSuccess || userInfo.Data == null)
    {
        return BaseResponse<IEnumerable<MemberContactDto>>.UnauthorizedResult("Token inv√°lido ou expirado");
    }

    // 3. Valida√ß√£o de cada contato
    foreach (var contact in request.Contacts)
    {
        if (string.IsNullOrWhiteSpace(contact.Value))
        {
            return BaseResponse<IEnumerable<MemberContactDto>>.ErrorResult(
                $"Valor do contato {contact.Type} n√£o pode estar vazio", statusCode: 400);
        }

        if (contact.Value.Length < 3)
        {
            return BaseResponse<IEnumerable<MemberContactDto>>.ErrorResult(
                $"Valor do contato {contact.Type} deve ter pelo menos 3 caracteres", statusCode: 400);
        }
    }

    // 4. Valida√ß√£o de exist√™ncia do membro
    var member = await _unitOfWork.Repository<Member>().GetByIdAsync(userId, cancellationToken);
    if (member == null)
    {
        return BaseResponse<IEnumerable<MemberContactDto>>.NotFoundResult("Membro n√£o encontrado");
    }

    // 5. Processar atualiza√ß√£o...
}
```

## üé® Interface de Usu√°rio

### 1. **Design Responsivo**
```typescript
// Layout responsivo
<Box sx={{
  display: "flex",
  gap: { xs: 2, sm: 2 },
  alignItems: "flex-start",
  flexDirection: { xs: "column", sm: "row" },
  width: "100%"
}}>
  {/* Seletor de Pa√≠s */}
  <FormControl sx={{
    minWidth: { xs: "100%", sm: 140, md: 160 },
    width: { xs: "100%", sm: "auto" }
  }}>
    {/* ... */}
  </FormControl>

  {/* Input de Telefone */}
  <TextField sx={{
    flex: 1,
    minWidth: { xs: "100%", sm: 200 },
    "& .MuiInputBase-input": {
      minHeight: { xs: 48, sm: 40 },
      fontSize: { xs: "16px", sm: "14px" }
    }
  }} />
</Box>
```

### 2. **Valida√ß√£o Visual**
```typescript
// Bot√£o prim√°rio com valida√ß√£o
<Button
  variant={contact.isPrimary ? "contained" : "outlined"}
  disabled={!canBePrimary(index)}
  title={!canBePrimary(index) 
    ? `J√° existe um ${contact.type} marcado como prim√°rio`
    : contact.isPrimary 
    ? "Este contato √© prim√°rio"
    : "Tornar este contato prim√°rio"
}
>
  {contact.isPrimary ? "Prim√°rio" : "Tornar Prim√°rio"}
</Button>

// Chip de aviso
{!canBePrimary(index) && !contact.isPrimary && (
  <Chip
    label="N√£o pode ser prim√°rio"
    color="warning"
    size="small"
    variant="outlined"
  />
)}
```

### 3. **Exibi√ß√£o de Dados Sens√≠veis**
```typescript
// SensitiveDataField com formata√ß√£o
const formatValue = (val: string) => {
  if (type === 'tel' && val.startsWith('+')) {
    try {
      const parsed = parsePhoneNumber(val);
      return parsed ? parsed.formatInternational() : val;
    } catch (error) {
      return val;
    }
  }
  return val;
};

const getMaskedValue = () => {
  if (type === 'email') {
    const [localPart, domain] = value.split('@');
    if (localPart && domain) {
      const maskedLocal = localPart.length > 2
        ? `${localPart[0]}${'‚Ä¢'.repeat(localPart.length - 2)}${localPart[localPart.length - 1]}`
        : '‚Ä¢‚Ä¢';
      return `${maskedLocal}@${domain}`;
    }
  }
  
  if (type === 'tel') {
    return value.startsWith('+') 
      ? value.replace(/\d/g, '‚Ä¢')  // +‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢-‚Ä¢‚Ä¢‚Ä¢‚Ä¢
      : value.replace(/\d/g, '‚Ä¢'); // (‚Ä¢‚Ä¢) ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢-‚Ä¢‚Ä¢‚Ä¢‚Ä¢
  }
  
  return '‚Ä¢'.repeat(Math.min(value.length, 8));
};
```

## üß™ Testes de Valida√ß√£o

### Cen√°rios de Teste

#### 1. **Telefone V√°lido**
```typescript
// Brasil
"+5511999999999" ‚Üí ‚úÖ V√°lido
"+5511987654321" ‚Üí ‚úÖ V√°lido

// EUA
"+1234567890" ‚Üí ‚úÖ V√°lido
"+15551234567" ‚Üí ‚úÖ V√°lido

// Portugal
"+351123456789" ‚Üí ‚úÖ V√°lido
```

#### 2. **Telefone Inv√°lido**
```typescript
"+5511999" ‚Üí ‚ùå Muito curto
"+551199999999999" ‚Üí ‚ùå Muito longo
"11999999999" ‚Üí ‚ùå Sem DDI
"abc123" ‚Üí ‚ùå Caracteres inv√°lidos
```

#### 3. **Email V√°lido**
```typescript
"usuario@exemplo.com" ‚Üí ‚úÖ V√°lido
"teste.email@dominio.org" ‚Üí ‚úÖ V√°lido
"a@b.co" ‚Üí ‚úÖ V√°lido (m√≠nimo)
```

#### 4. **Email Inv√°lido**
```typescript
"usuario@" ‚Üí ‚ùå Sem dom√≠nio
"@exemplo.com" ‚Üí ‚ùå Sem usu√°rio
"usuario" ‚Üí ‚ùå Sem @
"a@b" ‚Üí ‚ùå Dom√≠nio muito curto
```

#### 5. **Contatos Prim√°rios**
```typescript
// ‚úÖ V√°lido: Um telefone + um email prim√°rios
[
  { type: "Phone", value: "+5511999999999", isPrimary: true },
  { type: "Email", value: "user@example.com", isPrimary: true }
]

// ‚ùå Inv√°lido: Dois telefones prim√°rios
[
  { type: "Phone", value: "+5511999999999", isPrimary: true },
  { type: "Phone", value: "+5511888888888", isPrimary: true }
]

// ‚ùå Inv√°lido: Dois emails prim√°rios
[
  { type: "Email", value: "user1@example.com", isPrimary: true },
  { type: "Email", value: "user2@example.com", isPrimary: true }
]
```

## üìä Status de Implementa√ß√£o

### ‚úÖ Implementado e Funcionando

1. **Valida√ß√£o de Formato**
   - ‚úÖ Telefone internacional com DDI
   - ‚úÖ Email com formato b√°sico
   - ‚úÖ Comprimento m√≠nimo de 3 caracteres

2. **Valida√ß√£o de Prim√°rios**
   - ‚úÖ Apenas um telefone prim√°rio
   - ‚úÖ Apenas um email prim√°rio
   - ‚úÖ Valida√ß√£o visual no frontend
   - ‚úÖ Valida√ß√£o no backend

3. **Interface Responsiva**
   - ‚úÖ Design mobile-first
   - ‚úÖ Breakpoints responsivos
   - ‚úÖ Espa√ßamento otimizado

4. **Valida√ß√£o de Autentica√ß√£o**
   - ‚úÖ Token JWT obrigat√≥rio
   - ‚úÖ Verifica√ß√£o de usu√°rio existente

### üîÑ Pr√≥ximos Passos

1. **Valida√ß√£o de Unicidade**
   - üîÑ Email √∫nico global
   - üîÑ Telefone √∫nico global

2. **Valida√ß√£o Avan√ßada**
   - üîÑ Valida√ß√£o de CPF
   - üîÑ Valida√ß√£o de RG

3. **Testes Automatizados**
   - üîÑ Testes unit√°rios
   - üîÑ Testes de integra√ß√£o

## üîó Refer√™ncias

- [Documenta√ß√£o do react-phone-number-input](https://github.com/catamphetamine/react-phone-number-input)
- [Documenta√ß√£o do libphonenumber-js](https://github.com/catamphetamine/libphonenumber-js)
- [Documenta√ß√£o do Material-UI](https://mui.com/)
- [Documenta√ß√£o do Entity Framework Core](https://docs.microsoft.com/en-us/ef/core/)

---

**√öltima atualiza√ß√£o**: Dezembro 2024  
**Vers√£o**: 1.0.0  
**Status**: Implementado e Funcionando
