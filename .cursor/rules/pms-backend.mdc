---
description: Voc√™ √© um engenheiro s√™nior .NET e tamb√©m um gerente t√©cnico disciplinado. Construa a API REST **pms-backend** do projeto **PathfinderManagementSoftware** em **ASP.NET Core .NET 8 (LTS)** com **EF Core (code-first)** e **PostgreSQL 16**.

globs:
  - "src/**/*.cs"
  - "tests/**/*.cs"
  - "*.csproj"
  - "*.sln"
  - "*.json"
  - "*.yml"
  - "*.yaml"
  - "*.md"
  - "*.sql"
  - "*.ps1"
  - "*.sh"
  - "Dockerfile*"
  - "docker-compose*.yml"
  - ".editorconfig"
  - "dotnet-tools.json"
  - "*.mdc"
alwaysApply: true
---

# üìã PMS Backend - Regras de Desenvolvimento

## üìë √çndice

- [üéØ Governan√ßa de MVPs](#governan√ßa-de-mvps)
- [üèóÔ∏è Arquitetura e Plataforma](#arquitetura-e-plataforma)
- [üîê Autentica√ß√£o e Autoriza√ß√£o](#autentica√ß√£o-e-autoriza√ß√£o)
- [üèõÔ∏è Hierarquia e Rela√ß√µes](#hierarquia-e-rela√ß√µes)
- [üë• Pessoas, Cargos e Regras](#pessoas-cargos-e-regras)
- [üìö Programa e Progresso](#programa-e-progresso)
- [üéâ Eventos e Participa√ß√µes](#eventos-e-participa√ß√µes)
- [üìä Relat√≥rios e Exporta√ß√µes](#relat√≥rios-e-exporta√ß√µes)
- [üîß Qualidade e Testes](#qualidade-e-testes)
- [üìà MVPs e Escopo](#mvps-e-escopo)
- [‚è≥ Status Pending e Onboarding](#status-pending-e-onboarding)
- [üöÄ Quick Reference](#quick-reference)

---

## üéØ Governan√ßa de MVPs

### ‚ö†Ô∏è SCOPE LOCK - OBRIGAT√ìRIO

- **Entregas por MVP** em fatias verticais
- **MVPs dispon√≠veis**: MVP-0 (N√∫cleo operacional), MVP-1 (Programa/Aprova√ß√µes/Investiduras), MVP-2 (Opera√ß√£o ampliada)
- **N√ÉO implementar** nada fora do MVP vigente
- Itens fora do escopo ‚Üí **OPEN_QUESTIONS** no **PROGRESS.md**
- **Crit√©rios de aceite** obrigat√≥rios para cada MVP
- **Relat√≥rio de aceite** em **ACCEPTANCE.md** com casos verificados
- **S√≥ avan√ßar** para pr√≥ximo MVP quando atual for **ACEITO** (flag "MVP-X: ACCEPTED")

### üìã Ordem de Execu√ß√£o Recomendada

1. **Backend** do MVP vigente
2. **Integra√ß√£o m√≠nima Frontend** do mesmo MVP
3. **Aceite** do MVP atual
4. **Pr√≥ximo MVP**

---

## üèóÔ∏è Arquitetura e Plataforma

### üéØ Fase e Contexto

- **Fase 1**: BACKEND (atual)
- **Fase 2**: FRONTEND React (consumir√° OpenAPI)
- **Gerar**: OpenAPI 3.1 (JSON e YAML) + client TypeScript (NSwag)
- **Habilitar**: CORS com exemplos no README

### üìÅ Estrutura de Diret√≥rios - CR√çTICO

**‚ö†Ô∏è IMPORTANTE**: A estrutura de diret√≥rios do backend foi reorganizada para monorepo:

- **Caminho correto da API**: `src/backend/Pms.Backend.Api/`
- **Comando para executar**: `cd src/backend/Pms.Backend.Api && dotnet run`
- **Solu√ß√£o**: `src/backend/Pms.Backend.sln`
- **Docker context**: `src/backend/` (conforme docker-compose.yml)

**üìù Regra de Atualiza√ß√£o**: Sempre que houver altera√ß√£o na estrutura de diret√≥rios, esta se√ß√£o DEVE ser atualizada imediatamente para evitar confus√£o e erros de execu√ß√£o.

### üõ†Ô∏è Stack Tecnol√≥gica

| Componente      | Tecnologia               | Vers√£o       |
| --------------- | ------------------------ | ------------ |
| Framework       | ASP.NET Core             | .NET 8 (LTS) |
| Banco de Dados  | PostgreSQL               | 16           |
| ORM             | EF Core                  | Code-first   |
| Documenta√ß√£o    | Swashbuckle              | OpenAPI 3.1  |
| Valida√ß√£o       | FluentValidation         | HTTP 422     |
| Testes          | xUnit + FluentAssertions | -            |
| Observabilidade | Serilog + OpenTelemetry  | -            |

### üèõÔ∏è Arquitetura Clean

```
Pms.Backend.sln
‚îú‚îÄ‚îÄ Pms.Backend.Domain/          # Entities, ValueObjects, DomainServices, Events
‚îú‚îÄ‚îÄ Pms.Backend.Application/     # UseCases, DTOs, Validation, Mappings
‚îú‚îÄ‚îÄ Pms.Backend.Infrastructure/  # EF Core, Npgsql, Repos, Migrations, Seeds
‚îú‚îÄ‚îÄ Pms.Backend.Api/            # Controllers, Auth, Swagger, CORS
‚îî‚îÄ‚îÄ Pms.Backend.Tests/          # Unit, Integration, Acceptance Tests
```

### ‚öôÔ∏è Configura√ß√µes de Qualidade

- **TargetFramework**: net8.0 (LTS)
- **Banco**: PostgreSQL 16 (Npgsql) - sem SQLite
- **√çndices parciais** para "unicidade quando ativo"
- **Observabilidade**: Serilog + CorrelationId + OpenTelemetry (DEV)
- **Valida√ß√µes**: FluentValidation ‚Üí HTTP 422
- **Qualidade**: analyzers + warnings-as-errors + nullable enable
- **CI**: GitHub Actions (build+test + verifica√ß√£o de migra√ß√µes)

---

## üîê Autentica√ß√£o e Autoriza√ß√£o

### üîë JWT e Claims

```json
{
  "sub": "user-id",
  "email": "user@example.com",
  "roles": ["Director", "Regional"],
  "scopes": ["Club:123", "Region:456"],
  "exp": 1234567890
}
```

### üë§ Sistema de Usu√°rios

- **E-mail √∫nico global** (inclusive para arquivados)
- **Senha**: Argon2/BCrypt com hist√≥rico de 5 senhas
- **Sem registro p√∫blico** no MVP
- **Cria√ß√£o via** `POST /members`
- **Seed SystemAdmin** com token de ativa√ß√£o

### üîÑ Fluxo de Ativa√ß√£o

1. **Convite** ‚Üí token 24h
2. **Ativa√ß√£o** ‚Üí `/auth/activate`
3. **Esqueci senha** ‚Üí reset via token

### üîì Release de E-mail

**Apenas SystemAdmin/Regional‚Üë**:

1. Confirma√ß√£o + motivo
2. Mascarar e-mail no registro antigo
3. Remover UserCredential
4. Logar em SecurityAuditLog

---

## üèõÔ∏è Hierarquia e Rela√ß√µes

### üìä Cadeia Hier√°rquica

```
Divis√£o ‚Üí Uni√£o ‚Üí Associa√ß√£o ‚Üí Regi√£o ‚Üí Distrito ‚Üí Clube ‚Üí Unidade ‚Üí Membro
```

### üîó Rela√ß√µes Obrigat√≥rias

- **Clube ‚Üî Igreja**: 1:1 obrigat√≥rio
- **Igreja**: CEP √∫nico global
- **Cada n√≠vel**: 1 pai, 0..N filhos
- **Clube**: pertence a 1 Distrito (obrigat√≥rio)

### üè∑Ô∏è C√≥digos e CodePath

| Campo      | Regras                                   | Exemplo                      |
| ---------- | ---------------------------------------- | ---------------------------- |
| `Code`     | ‚â§5 chars, UPPERCASE A-Z0-9, manual       | `DSA`, `UCB`                 |
| `CodePath` | ‚â§60 chars, somente leitura, concatena√ß√£o | `DSA.UCB.APL.APL3RT.DVM.PAC` |

### üîÑ Mudan√ßa de Pai

- **Recalcular** `CodePath` em cascata
- **Mesma transa√ß√£o** para consist√™ncia
- **Unicidade**: Code √∫nico por n√≠vel, CodePath √∫nico global

---

## üë• Pessoas, Cargos e Regras

### üëî Pap√©is por N√≠vel

#### üèõÔ∏è Lideran√ßa Superior

- **Uni√£o**: 1 Pastor da Uni√£o (‚â•18, Batismo+Len√ßo)
- **Associa√ß√£o**: 1 Pastor da Associa√ß√£o (‚â•18, Batismo+Len√ßo)
- **Regi√£o**: 1 Pastor da Regi√£o (‚â•18, Batismo+Len√ßo) + 1 Regional (‚â•18)

#### üèòÔ∏è Lideran√ßa Local

- **Distrito**: 1 Distrital (‚â•18)
- **Clube**: Diretoria com regras espec√≠ficas
- **Unidade**: Conselheiros e juvenis

### üèõÔ∏è Diretoria do Clube

| Cargo                | Quantidade   | Idade | G√™nero    | Requisitos    |
| -------------------- | ------------ | ----- | --------- | ------------- |
| Diretor              | 1            | ‚â•18   | -         | Batismo+Len√ßo |
| Diretores Associados | ‚â§2           | ‚â•16   | Distintos | -             |
| Secret√°rio           | 1            | ‚â•16   | -         | -             |
| Anci√£o               | 1 (opcional) | ‚â•18   | -         | Batismo+Len√ßo |
| Capel√£o              | 1 (opcional) | ‚â•18   | -         | Batismo+Len√ßo |
| Instrutores          | N            | ‚â•16   | -         | -             |

### üö´ Regras de Ac√∫mulo

- **Sem ac√∫mulo** de cargos de diretoria no Clube
- **Instrutor incluso** na regra de ac√∫mulo
- **Requisitos espirituais**: Batismo + Len√ßo para toda lideran√ßa

### üîÑ Promo√ß√µes e Baixas

#### Regional/Distrital/Pastores

- **Proibido**: membership de clube e v√≠nculo de unidade
- **Ao assumir**: encerrar memberships/cargos de Clube/Unidade
- **Ao deixar**: servi√ßo "associar a um clube"

#### Rebaixamento

- **Regional ‚Üî Distrital**: cargo anterior √© perdido (mant√©m hist√≥rico)

### üë• Delegado de Aprova√ß√£o

```csharp
ApprovalDelegate {
    Role,           // Cargo que pode delegar
    ScopeType,      // Tipo do escopo
    ScopeId,        // ID do escopo
    Start,          // Data in√≠cio
    End,            // Data fim
    DelegatedToAssignmentId  // Para quem delegou
}
```

**Regras**:

- Regional pode delegar a Distrital da sua Regi√£o
- Ou a Regional de outra Regi√£o
- **Conflito de interesse**: n√£o aprova pr√≥prio progresso nem de filho

---

## üìö Programa e Progresso

### üéì Classes Regulares

| Classe        | Idade | Ordem |
| ------------- | ----- | ----- |
| Amigo         | 10    | 1     |
| Companheiro   | 11    | 2     |
| Pesquisador   | 12    | 3     |
| Pioneiro      | 13    | 4     |
| Excursionista | 14    | 5     |
| Guia          | 15    | 6     |

### üèÜ Classes Avan√ßadas

- **Podem iniciar** a qualquer momento
- **S√≥ concluem** ap√≥s a respectiva regular estar **Conclu√≠da**

### üëë Lideran√ßa

| Cargo                 | Idade In√≠cio | Idade Investidura | Pr√©-requisitos       |
| --------------------- | ------------ | ----------------- | -------------------- |
| L√≠der                 | ‚â•16          | ‚â•18               | Regulares conclu√≠das |
| L√≠der Master          | -            | -                 | Requer L√≠der         |
| L√≠der Master Avan√ßado | -            | -                 | Requer L√≠der Master  |

**Regra**: N√£o √© permitido pular regulares e ir direto a L√≠der

### üèÖ Especialidades

#### Categorias Can√¥nicas

- **AD, HM, AA, AM, AP, AR, CS, EN, HD**
- **Chave**: Acronym (‚â§3 alfanum.) + Code (1..999)
- **Exibi√ß√£o**: D3 (001, 010, 245)
- **M√∫ltiplas**: mesmo membro pode ter v√°rias da mesma categoria

### üéñÔ∏è Mestrados

- **Entidade pr√≥pria** (`Mastery`)
- **Independentes** de classes
- **Requisitos**: AND/OR/MIN-OF-N por especialidades
- **Hist√≥rico √∫nico**: n√£o repetir itens j√° Conclu√≠dos

---

## üéâ Eventos e Participa√ß√µes

### üìÖ Organiza√ß√£o

- **Qualquer n√≠vel**: Divis√£o/Uni√£o/Associa√ß√£o/Regi√£o/Distrito/Clube
- **Registrar**: `OrganizerLevel` e `OrganizerId`

### ‚úÖ Elegibilidade Multi-dia

- **Membro ativo** em toda a janela (Start‚ÜíEnd)
- **Clube inativo**: membros **n√£o** podem participar
- **Lideran√ßas sem membership**: podem participar

### üí∞ Taxas

- **FeeAmount?/FeeCurrency?** por evento
- **Default**: gratuito
- **Moeda global**: BRL (configur√°vel)

---

## üìä Relat√≥rios e Exporta√ß√µes

### üìà Exporta√ß√µes CSV (Diretor)

| Endpoint                                                   | Descri√ß√£o          | Formato    |
| ---------------------------------------------------------- | ------------------ | ---------- |
| `/reports/members.csv?clubId=...`                          | Membros do clube   | UTF-8, `;` |
| `/reports/timeline.csv?memberId=...`                       | Timeline do membro | UTF-8, `;` |
| `/reports/participations.csv?clubId=...&start=...&end=...` | Participa√ß√µes      | UTF-8, `;` |

### üìÖ Datas

- **Persistir**: UTC
- **Exibir/Validar**: America/Sao_Paulo (Hor√°rio de Bras√≠lia)

---

## üîß Qualidade e Testes

### üß™ Cobertura M√≠nima

- **Domain + Application**: ‚â•70%
- **Total**: ‚â•60%

### ‚úÖ Casos de Teste Obrigat√≥rios

#### Membership

- [ ] Membership √∫nica (e "0 ativa" para Regional/Distrital/Pastores)
- [ ] Regra 1¬∫/06
- [ ] Capacidade de unidade
- [ ] 0/>1 op√ß√µes ‚Üí tarefas/422

#### Diretoria

- [ ] 1 Diretor
- [ ] Associados (m√°x. 2, g√™neros distintos)
- [ ] Sem ac√∫mulo
- [ ] Clube sem diretor ‚Üí `IsActive=false` + bloqueios

#### Aprova√ß√µes

- [ ] Cadeias de aprova√ß√£o (pular Distrital)
- [ ] Conflito/auto/familiar ‚Üí pular
- [ ] Delegado de aprova√ß√£o

#### Outros

- [ ] Gating por Len√ßo
- [ ] Investidura (testemunhas ativas na data/escopo)
- [ ] CodePath recalculado em cascata
- [ ] Clube inativo bloqueia eventos/progressos

### üîí Gating por Len√ßo (Scarf)

#### Aplica√ß√£o

- **Escopo**: Classes (regulares e avan√ßadas), Especialidades e Mestrados
- **Endpoints bloqueados sem len√ßo**: `/start`, `/patch` (updates), `/submit`, `/approve`
- **Erro**: 422 ScarfRequired
- **Leituras (GET)**: N√£o s√£o bloqueadas

#### Valida√ß√£o

- **Campo**: `Member.ScarfInvested = true`
- **Mensagem**: "Opera√ß√£o '{operationType}' requer investidura de len√ßo. O membro deve ter recebido o len√ßo antes de iniciar progressos."

### üéñÔ∏è Investiduras - Testemunhas

#### Estrutura InvestitureWitness

```csharp
InvestitureWitness {
    Type,                    // Structured | Text
    MemberId?,               // quando Structured
    RoleSnapshot?,           // quando Structured { Role, ScopeType, ScopeCodePath, EffectiveDate }
    NameText?,               // quando Text (VARCHAR(200))
    RoleText?,               // quando Text (VARCHAR(100))
    OrgText?,                // quando Text (VARCHAR(120))
}
```

#### Regras de Valida√ß√£o

- **‚â•1 testemunha** obrigat√≥ria (qualquer Type) em toda investidura
- **Lideran√ßa**: obrigat√≥rio "Pastor da Associa√ß√£o" (Structured ou Text)
- **Fallback**: "Pastor da Uni√£o" se "Pastor da Associa√ß√£o" indispon√≠vel
- **Override admin**: se nenhum dos dois for vi√°vel, exigir motivo + Task "Validar Investidura de Lideran√ßa (sem Pastor)"
- **Aprovador ‚â† Testemunha**: permitido (n√£o no mesmo ato de auto-testemunho)

### üè¢ Clube Inativo - Bloqueios

#### Fonte de Verdade

- **Campo**: `Club.IsActive` (persistido)
- **Atualiza√ß√£o**: eventos de dom√≠nio
  - `false` quando n√£o existir Diretor ativo
  - `true` ao nomear novo Diretor

#### Bloqueios (IsActive = false)

**No escopo do clube:**
- Cria√ß√£o/altera√ß√£o de eventos
- Cria√ß√£o/altera√ß√£o de cargos
- Cria√ß√£o/altera√ß√£o de memberships
- Aprova√ß√µes
- Investiduras

**Membros com membership no clube:**
- Participa√ß√£o em eventos
- Progresso (start/update/submit/approve)
- Investiduras

**Exce√ß√µes:**
- Regionais/Distritais/Pastores (sem membership de clube) continuam aptos em seus escopos
- Podem participar de eventos
- Aprova√ß√µes relativas a membros do clube inativo permanecem bloqueadas

#### Tarefas Autom√°ticas

- "Reativar Clube (nomear Diretor)"
- "Ofertar Realoca√ß√£o" conforme regras j√° definidas

### üîí Seguran√ßa

- **Pol√≠tica de senha**: min 10; 1 mai√∫scula; 1 min√∫scula; 1 d√≠gito
- **Hist√≥rico**: 5 senhas
- **Lockout**: 5/15‚Üí15 (configur√°vel)
- **Rate limit**: global habilitado (por IP e por usu√°rio)

---

## üìà MVPs e Escopo

### üéØ MVP-0: N√∫cleo Operacional

**Escopo**:

- Plataforma/seguran√ßa
- Hierarquia+igrejas (Code/CodePath)
- Membros (‚â•10, batismo)
- Convite/ativa√ß√£o
- Len√ßo
- Clubes/unidades/membership
- Cargos/sem ac√∫mulo
- Delegado
- Eventos (eligibilidade multi-dia)
- Timeline b√°sica
- CSV Director

### üéØ MVP-1: Programa/Aprova√ß√µes/Investiduras

**Escopo**:

- Categorias/especialidades/classes/mestrados
- Progressos (status, gating len√ßo)
- Cadeias (pulos/Delegado/Conflito)
- Reprova√ß√£o/reabertura
- Investiduras (testemunhas ativas)

### üéØ MVP-2: Opera√ß√£o Ampliada

**Escopo**:

- Relat√≥rios ampliados
- Caches opcionais
- Webhooks/notifica√ß√µes
- Anexos bin√°rios (S3/local)
- Rate-limit por papel

---

## ‚è≥ Status Pending e Onboarding

### üìä Member Status

- **Pending**: Membro rec√©m-cadastrado com dados incompletos
- **Active**: Membro com dados completos e ativo
- **Archived**: Membro arquivado/inativo

### üîÑ Activation Checklist (MVP)

**Crit√©rios para ativa√ß√£o autom√°tica (Pending ‚Üí Active)**:

- ‚úÖ **Address completo**: zipCode, street, number, city, state
- ‚úÖ **Contact Email**: presente (do convite)
- ‚úÖ **Mobile recomendado**: n√£o obrigat√≥rio no MVP

### üö´ Operation Checklist

**N√£o afeta status, mas bloqueia opera√ß√µes de neg√≥cio**:

- ‚úÖ **ScarfInvestiture**: requerido para progress (classes/especialidades/mestrados)
- ‚úÖ **BaptismValidComputed**: true AND no active censure AND ScarfInvested = true para leadership

### üîê Login e Permiss√µes

#### Status Pending

- ‚úÖ **Login permitido**: JWT emitido normalmente
- ‚ùå **Escritas de dom√≠nio bloqueadas**: 403 MemberPending
- ‚úÖ **Endpoints /me/**: permitidos para completar cadastro

#### Status Active

- ‚úÖ **Todas as opera√ß√µes**: permitidas conforme permiss√µes

### üìù Login Response Structure

```json
{
  "token": "jwt_token_here",
  "member": {
    "id": "uuid",
    "status": "Pending|Active|Archived"
  },
  "pending": {
    "activationRequired": ["Address", "ContactEmail"],
    "operationRequired": ["ScarfInvestiture", "BaptismInfo"],
    "optional": ["MedicalInfo"],
    "blockingWrites": true
  }
}
```

**Regras do Login Response**:

- Chaves de "pending" **SEMPRE em ingl√™s**
- JWT permanece enxuto (sub, email, name, roles[], scopes[], exp)
- **N√ÉO incluir** "pending" no token JWT

### üë§ Create Member - Investidura Opcional

```json
{
  "firstName": "string",
  "lastName": "string",
  "dateOfBirth": "datetime",
  "gender": "enum",
  "cpf": "string",
  "rg": "string",
  "addressInfo": {
    /* CreateMemberAddressDto */
  },
  "loginInfo": {
    /* CreateMemberLoginInfoDto */
  },
  "contacts": [
    /* CreateMemberContactDto[] */
  ],
  "baptismInfo": {
    /* CreateMemberBaptismInfoDto - opcional */
  },
  "medicalInfo": {
    /* CreateMemberMedicalInfoDto - opcional */
  },
  "initialScarfInvestiture": {
    /* InvestitureDto - opcional */
  }
}
```

**Regras de Cria√ß√£o**:

- Valida√ß√£o de CPF e Email √∫nicos antes da cria√ß√£o
- Idade m√≠nima: 10 anos (baseado em 1¬∫ de junho do ano vigente)
- Dados m√≠nimos: FirstName, LastName, DateOfBirth, Gender, CPF, RG
- Address: zipCode, street, number, neighborhood, city, state (obrigat√≥rio)
- LoginInfo: email, password (obrigat√≥rio)
- Contacts: pelo menos 1 contato Mobile (obrigat√≥rio)
- Email do LoginInfo vira contato Email principal automaticamente

### üö® Error Codes

| C√≥digo | Significado                       | Uso                                            |
| ------ | --------------------------------- | ---------------------------------------------- |
| 403    | MemberPending                     | Tenta opera√ß√£o de dom√≠nio com status Pending   |
| 422    | ScarfRequired                     | Progresso sem len√ßo                            |
| 422    | RequisitosEspirituaisNaoAtendidos | Lideran√ßa sem batismo v√°lido/len√ßo/sem censura |

### üîÑ Ativa√ß√£o Autom√°tica

- **Idempotente**: verifica√ß√£o cont√≠nua do activation checklist
- **Autom√°tica**: promo√ß√£o para Active quando crit√©rios atendidos
- **Logs**: registrar mudan√ßas de status para auditoria

---

## üöÄ Quick Reference

### üîó Endpoints Principais

#### Autentica√ß√£o

- `POST /auth/invite` - Convite de usu√°rio
- `POST /auth/activate` - Ativa√ß√£o de conta
- `POST /auth/forgot-password` - Esqueci senha
- `POST /auth/reset-password` - Reset de senha

#### Membros

- `POST /members` - Criar membro completo (‚â•10 anos, com sub-objetos)
- `GET /members/me` - Dados do pr√≥prio membro (permitido para Pending)
- `PUT /members/me` - Atualizar dados do pr√≥prio membro (permitido para Pending)
- `POST /members/{id}/memberships` - Criar membership
- `POST /memberships/{id}/close` - Encerrar membership

#### Cargos

- `POST /assignments` - Criar cargo
- `POST /assignments/{id}/close` - Encerrar cargo
- `POST /assignments/associate-to-club` - Associar a clube

#### Progresso

- `POST /members/{id}/classes/{classId}/start` - Iniciar classe
- `PATCH /members/{id}/classes/{classId}` - Atualizar progresso
- `POST /progress/{itemType}/{itemId}/approve` - Aprovar progresso

### üìä C√≥digos de Status

| C√≥digo | Significado                       | Uso                                                    |
| ------ | --------------------------------- | ------------------------------------------------------ |
| 200    | OK                                | Sucesso                                                |
| 201    | Created                           | Cria√ß√£o bem-sucedida                                   |
| 400    | Bad Request                       | Dados inv√°lidos                                        |
| 401    | Unauthorized                      | N√£o autenticado                                        |
| 403    | Forbidden                         | Sem permiss√£o                                          |
| 403    | MemberPending                     | Membro com status Pending tentando opera√ß√£o de dom√≠nio |
| 404    | Not Found                         | Recurso n√£o encontrado                                 |
| 422    | Unprocessable Entity              | Viola√ß√£o de regra de neg√≥cio                           |
| 422    | ScarfRequired                     | Progresso sem len√ßo                                    |
| 422    | RequisitosEspirituaisNaoAtendidos | Lideran√ßa sem batismo v√°lido/len√ßo/sem censura         |
| 500    | Internal Server Error             | Erro interno                                           |

### üîß Feature Flags

| Flag                  | Default | Descri√ß√£o                  |
| --------------------- | ------- | -------------------------- |
| `Attachments.Enabled` | false   | Anexos bin√°rios (S3/local) |
| `Redis.Enabled`       | false   | Cache Redis                |
| `Jobs.Enabled`        | true    | Jobs de realoca√ß√£o         |
| `Exports.Enabled`     | true    | Exporta√ß√µes CSV            |
| `RateLimit.ByRole`    | false   | Rate limit por papel       |

---

## üìù Notas Importantes

### ‚ö†Ô∏è Orienta√ß√µes Finais

- **Em caso de ambiguidade**: N√ÉO implemente
- **Registre** em OPEN_QUESTIONS no PROGRESS.md
- **N√ÉO avance** para pr√≥ximo MVP sem "MVP-X: ACCEPTED"
- **Mantenha escopo** estritamente conforme este documento

### üîÑ PATCH - Investiduras: Testemunhas

#### Modelo H√≠brido para Hist√≥ricos

**Objetivo**: Permitir registrar investiduras antigas/legadas quando n√£o for poss√≠vel vincular testemunhas a pessoas/cargos existentes.

#### Estrutura de Dados

```csharp
InvestitureWitness {
    Id,
    InvestitureId,           // FK
    Type,                    // Structured | Text
    MemberId?,               // quando Structured
    RoleSnapshot?,           // quando Structured
    NameText?,               // quando Text (VARCHAR(200))
    RoleText?,               // quando Text (VARCHAR(100))
    OrgText?,                // opcional (VARCHAR(120))
    CreatedAtUtc
}
```

#### Regras de Valida√ß√£o

- **‚â•1 testemunha** obrigat√≥ria
- **Prefer√™ncia**: Structured quando poss√≠vel
- **Fallback texto**: para casos antigos
- **Auto-testemunho**: proibido
- **Aprovador ‚â† Testemunha**: permitido

#### Lideran√ßa - Exig√™ncias Espec√≠ficas

**Investiduras de lideran√ßa** devem conter:

- Pelo menos **uma testemunha** com cargo **"Pastor da Associa√ß√£o"**
- **Fallback**: "Pastor da Uni√£o"
- **Override administrativo**: se nenhum dos dois for vi√°vel

---

_Documento atualizado em: $(date)_
_Vers√£o: 2.0_
